service: uptime-monitor-cron

# Serverless Framework loads .env.lambda for AWS Lambda deployment
# Contains only NEXT_PUBLIC_APP_URL and CRON_SECRET
useDotenv: true

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'production'}
  timeout: 300 # 5 minutes timeout (reasonable for monitor checks)
  memorySize: 512
  environment:
    # Next.js App URL (required for Lambda to call the API)
    # Set this to your deployed app URL (Amplify/Vercel)
    NEXT_PUBLIC_APP_URL: ${env:NEXT_PUBLIC_APP_URL}
    # Optional - API endpoint security (recommended for production)
    CRON_SECRET: ${env:CRON_SECRET, ''}

package:
  individually: true

functions:
  monitorCron:
    handler: aws/handler.monitorCron
    description: Run uptime monitor checks
    events:
      # Run every 1 minute
      - schedule: rate(1 minute)
      # Also expose as HTTP endpoint for manual triggers
      - httpApi:
          path: /cron/monitor
          method: get

  # Optional: Manual trigger via API
  manualCheck:
    handler: aws/handler.manualCheck
    description: Manually trigger monitor check
    events:
      - httpApi:
          path: /api/monitors/{id}/check
          method: post

plugins:
  - serverless-esbuild
  - serverless-offline

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: false
    target: node20
    platform: node
    concurrency: 10
    packager: npm
    # Handler only uses built-in fetch() and types (not bundled)
    # Exclude AWS SDK (provided by Lambda runtime)
    external:
      - '@aws-sdk/*'
      - 'aws-sdk'
    # Exclude Next.js and heavy dependencies
    exclude:
      - 'next'
      - 'react'
      - 'react-dom'
      - 'mongoose'
      - 'nodemailer'
      - 'twilio'
      - 'axios'
      - 'recharts'
      - '@types/*'
  
  serverless-offline:
    httpPort: 3001
